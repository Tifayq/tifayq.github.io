#!/usr/bin/env sh

# Run this script to deploy the app to Github Pages.

# Exit if any subcommand fails.
set -e

echo "Started deploying"
echo "variables ${GITHUB_ACTOR}, ${GITHUB_TOKEN}, ${GITHUB_REPOSITORY}"
remote_repo="https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" && \
remote_branch="gh-pages"

echo "Setting up Ruby dependencies via Bundler."
gem install bundler --conservative
bundle check || bundle install
bundle update

echo "Setting up JS dependencies via Yarn."
npm install -g yarn

#git clone --depth=1 --single-branch --branch gh-pages https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git /tmp/gh-pages
#rm -rf /tmp/gh-pages/*

# Build site.
echo "Building"
yarn install --modules-folder ./_assets/yarn
bundle exec jekyll build

# Delete and move files.
# echo "Deploying to gh-pages"
# mkdir /tmp/gh-pages
# mv _site/* /tmp/gh-pages
# 
# cd /tmp/gh-pages
# git init && \
# git config --global user.name "${GITHUB_ACTOR}" && \
# git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com" && \
# 
# 
# git add -fA && \
# git commit --allow-empty -m "$(git log -1 --pretty=%B) [ci skip]" && \
# git push --force $remote_repo master:$remote_branch
# 
# echo "Deployed Successfully!"

exit 0
